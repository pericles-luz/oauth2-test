{{define "dashboard"}}
{{template "header" .}}

<div class="page-header">
    <h2>Dashboard</h2>
    <p>Autentica√ß√£o OAuth2 realizada com sucesso!</p>
</div>

{{if .Scopes}}
<div class="card card-highlight">
    <h3>Escopos Solicitados e Dados Obtidos</h3>
    <p style="color: #6b7280; margin-bottom: 1rem;">Rela√ß√£o entre os escopos OAuth2 solicitados e as informa√ß√µes disponibilizadas:</p>

    <div style="display: grid; gap: 1rem;">
        {{if contains .Scopes "openid"}}
        <div class="scope-card scope-card-blue">
            <div style="font-weight: bold; color: #2563eb; margin-bottom: 0.5rem;">
                <span class="tooltip">
                    üìã openid
                    <span class="tooltiptext">Escopo obrigat√≥rio para OpenID Connect que fornece o identificador √∫nico do usu√°rio</span>
                </span>
            </div>
            <div style="font-size: 0.875rem; color: #374151;">
                Identificador √∫nico do usu√°rio
                {{if .UserInfo.Sub}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                    ‚úì <strong>sub:</strong> <span style="font-family: monospace;">{{.UserInfo.Sub}}</span>
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        {{if contains .Scopes "profile"}}
        <div class="scope-card scope-card-green">
            <div style="font-weight: bold; color: #059669; margin-bottom: 0.5rem;">
                <span class="tooltip">
                    üë§ profile
                    <span class="tooltiptext">Informa√ß√µes b√°sicas do perfil incluindo nome, CPF e dados da seccional</span>
                </span>
            </div>
            <div style="font-size: 0.875rem; color: #374151;">
                Informa√ß√µes b√°sicas do perfil (nome, CPF, etc.)
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                    {{if .UserInfo.Name}}‚úì <strong>name:</strong> {{.UserInfo.Name}}<br>{{end}}
                    {{if .UserInfo.CPF}}‚úì <strong>cpf:</strong> {{.UserInfo.CPF}}{{end}}
                </div>
            </div>
        </div>
        {{end}}

        {{if contains .Scopes "email"}}
        <div class="scope-card scope-card-red">
            <div style="font-weight: bold; color: #dc2626; margin-bottom: 0.5rem;">
                <span class="tooltip">
                    üìß email
                    <span class="tooltiptext">Acesso ao endere√ßo de e-mail do usu√°rio e status de verifica√ß√£o</span>
                </span>
            </div>
            <div style="font-size: 0.875rem; color: #374151;">
                Endere√ßo de e-mail e status de verifica√ß√£o
                {{if .UserInfo.Email}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                    ‚úì <strong>email:</strong> {{.UserInfo.Email}}<br>
                    ‚úì <strong>email_verified:</strong> {{if .UserInfo.EmailVerified}}true{{else}}false{{end}}
                </div>
                {{else}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem; color: #9ca3af;">
                    Nenhum e-mail dispon√≠vel
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        {{if contains .Scopes "phone"}}
        <div class="scope-card scope-card-purple">
            <div style="font-weight: bold; color: #7c3aed; margin-bottom: 0.5rem;">
                <span class="tooltip">
                    üì± phone
                    <span class="tooltiptext">Acesso ao n√∫mero de telefone do usu√°rio e status de verifica√ß√£o</span>
                </span>
            </div>
            <div style="font-size: 0.875rem; color: #374151;">
                N√∫mero de telefone e status de verifica√ß√£o
                {{if .UserInfo.PhoneNumber}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                    ‚úì <strong>phone_number:</strong> {{.UserInfo.PhoneNumber}}<br>
                    ‚úì <strong>phone_number_verified:</strong> {{if .UserInfo.PhoneNumberVerified}}true{{else}}false{{end}}
                </div>
                {{else}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem; color: #9ca3af;">
                    Nenhum telefone dispon√≠vel
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        {{if contains .Scopes "address"}}
        <div class="scope-card scope-card-orange">
            <div style="font-weight: bold; color: #ea580c; margin-bottom: 0.5rem;">
                <span class="tooltip">
                    üè† address
                    <span class="tooltiptext">Informa√ß√µes completas de endere√ßo residencial do usu√°rio</span>
                </span>
            </div>
            <div style="font-size: 0.875rem; color: #374151;">
                Informa√ß√µes de endere√ßo completo
                {{if .UserInfo.Address}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                    ‚úì <strong>address:</strong> {{.UserInfo.Address}}
                </div>
                {{else}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem; color: #9ca3af;">
                    Nenhum endere√ßo dispon√≠vel
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        {{if or (contains .Scopes "union_info") (contains .Scopes "membership")}}
        <div class="scope-card scope-card-cyan">
            <div style="font-weight: bold; color: #0891b2; margin-bottom: 0.5rem;">
                <span class="tooltip">
                    üè¢ union_info / membership
                    <span class="tooltiptext">Informa√ß√µes sobre filia√ß√£o sindical, tipo de v√≠nculo e status de emprego</span>
                </span>
            </div>
            <div style="font-size: 0.875rem; color: #374151;">
                Informa√ß√µes sindicais e de filia√ß√£o
                {{if or .UserInfo.MembershipStatus .UserInfo.EmploymentStatus .UserInfo.MembershipType .UserInfo.UnionUnit}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                    {{if .UserInfo.MembershipStatus}}‚úì <strong>membership_status:</strong> {{.UserInfo.MembershipStatus}}<br>{{end}}
                    {{if .UserInfo.MembershipType}}‚úì <strong>membership_type:</strong> {{.UserInfo.MembershipType}}<br>{{end}}
                    {{if .UserInfo.EmploymentStatus}}‚úì <strong>employment_status:</strong> {{.UserInfo.EmploymentStatus}}<br>{{end}}
                    {{if .UserInfo.UnionUnit}}‚úì <strong>union_unit:</strong> {{.UserInfo.UnionUnit}}{{end}}
                </div>
                {{else}}
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem; color: #9ca3af;">
                    Nenhuma informa√ß√£o sindical dispon√≠vel
                </div>
                {{end}}
            </div>
        </div>
        {{end}}

        {{if .UserInfo.Permissions}}
        <div class="scope-card scope-card-yellow">
            <div style="font-weight: bold; color: #ca8a04; margin-bottom: 0.5rem;">
                <span class="tooltip">
                    üîê permissions
                    <span class="tooltiptext">Permiss√µes e roles espec√≠ficas concedidas ao usu√°rio no sistema</span>
                </span>
            </div>
            <div style="font-size: 0.875rem; color: #374151;">
                Permiss√µes espec√≠ficas concedidas
                <div style="margin-top: 0.5rem; padding: 0.5rem; background-color: white; border-radius: 0.25rem;">
                    {{range $i, $perm := .UserInfo.Permissions}}
                    {{if $i}}<br>{{end}}‚úì <strong>{{$perm}}</strong>
                    {{end}}
                </div>
            </div>
        </div>
        {{end}}
    </div>
</div>
{{end}}

{{if .UserInfo}}
<div class="card mt-3">
    <h3>Dados Obtidos do Escopo</h3>

    <h4 style="margin-top: 1.5rem; color: #2563eb; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem;">Identifica√ß√£o</h4>
    <div class="user-info">
        {{if .UserInfo.Sub}}
        <div class="info-row">
            <span class="label">Subject (Sub):</span>
            <span class="value">{{.UserInfo.Sub}}</span>
        </div>
        {{end}}
        {{if .UserInfo.Name}}
        <div class="info-row">
            <span class="label">Nome:</span>
            <span class="value"><strong>{{.UserInfo.Name}}</strong></span>
        </div>
        {{end}}
        {{if .UserInfo.CPF}}
        <div class="info-row">
            <span class="label">CPF:</span>
            <span class="value"><strong>{{.UserInfo.CPF}}</strong></span>
        </div>
        {{end}}
    </div>

    {{if or .UserInfo.Email .UserInfo.PhoneNumber}}
    <h4 style="margin-top: 1.5rem; color: #2563eb; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem;">Contato</h4>
    <div class="user-info">
        {{if .UserInfo.Email}}
        <div class="info-row">
            <span class="label">Email:</span>
            <span class="value">{{.UserInfo.Email}} {{if .UserInfo.EmailVerified}}<span style="color: #059669;">‚úì verificado</span>{{else}}<span style="color: #dc2626;">‚úó n√£o verificado</span>{{end}}</span>
        </div>
        {{end}}
        {{if .UserInfo.PhoneNumber}}
        <div class="info-row">
            <span class="label">Telefone:</span>
            <span class="value">{{.UserInfo.PhoneNumber}} {{if .UserInfo.PhoneNumberVerified}}<span style="color: #059669;">‚úì verificado</span>{{else}}<span style="color: #dc2626;">‚úó n√£o verificado</span>{{end}}</span>
        </div>
        {{end}}
    </div>
    {{end}}

    {{if .UserInfo.Address}}
    <h4 style="margin-top: 1.5rem; color: #2563eb; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem;">Endere√ßo</h4>
    <div class="user-info">
        <div class="info-row">
            <span class="label">Endere√ßo:</span>
            <span class="value">{{.UserInfo.Address}}</span>
        </div>
    </div>
    {{end}}

    {{if or .UserInfo.MembershipStatus .UserInfo.EmploymentStatus .UserInfo.MembershipType .UserInfo.UnionUnit}}
    <h4 style="margin-top: 1.5rem; color: #2563eb; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem;">Informa√ß√µes Sindicais</h4>
    <div class="user-info">
        {{if .UserInfo.MembershipStatus}}
        <div class="info-row">
            <span class="label">Status de Filia√ß√£o:</span>
            <span class="value"><strong>{{.UserInfo.MembershipStatus}}</strong></span>
        </div>
        {{end}}
        {{if .UserInfo.MembershipType}}
        <div class="info-row">
            <span class="label">Tipo de Filia√ß√£o:</span>
            <span class="value">{{.UserInfo.MembershipType}}</span>
        </div>
        {{end}}
        {{if .UserInfo.EmploymentStatus}}
        <div class="info-row">
            <span class="label">Status de Emprego:</span>
            <span class="value">{{.UserInfo.EmploymentStatus}}</span>
        </div>
        {{end}}
        {{if .UserInfo.UnionUnit}}
        <div class="info-row">
            <span class="label">Unidade Sindical:</span>
            <span class="value">{{.UserInfo.UnionUnit}}</span>
        </div>
        {{end}}
    </div>
    {{end}}

    {{if .UserInfo.Permissions}}
    <h4 style="margin-top: 1.5rem; color: #2563eb; border-bottom: 1px solid #e5e7eb; padding-bottom: 0.5rem;">Permiss√µes</h4>
    <div class="user-info">
        <div class="info-row">
            <span class="label">Permiss√µes Concedidas:</span>
            <span class="value">
                <ul style="margin: 0; padding-left: 1.5rem;">
                {{range .UserInfo.Permissions}}
                    <li><strong>{{.}}</strong></li>
                {{end}}
                </ul>
            </span>
        </div>
    </div>
    {{end}}
</div>
{{end}}

<details class="card mt-3 collapsible-section" open>
    <summary>Tokens OAuth2</summary>

    <div class="token-section">
        <h4>Access Token</h4>
        <div class="token-container">
            <button class="btn-copy" onclick="copyToken(this)">üìã Copiar</button>
            <textarea readonly class="token-field">{{.AccessToken}}</textarea>
        </div>
    </div>

    {{if .RefreshToken}}
    <div class="token-section mt-2">
        <h4>Refresh Token</h4>
        <div class="token-container">
            <button class="btn-copy" onclick="copyToken(this)">üìã Copiar</button>
            <textarea readonly class="token-field">{{.RefreshToken}}</textarea>
        </div>
    </div>
    {{end}}

    {{if .IDToken}}
    <div class="token-section mt-2">
        <h4>ID Token (JWT)</h4>
        <div class="token-container">
            <button class="btn-copy" onclick="copyToken(this)">üìã Copiar</button>
            <textarea readonly class="token-field">{{.IDToken}}</textarea>
        </div>
    </div>
    {{end}}
</details>

<div class="card mt-3">
    <h3>Testar Endpoints</h3>
    <p>Use os bot√µes abaixo para testar funcionalidades adicionais do OAuth2.</p>

    <div class="button-grid">
        <button hx-post="/test/refresh"
                hx-target="#test-result"
                hx-indicator="#loading-indicator"
                class="btn btn-secondary">
            <span class="tooltip">
                Refresh Token
                <span class="tooltiptext">Renovar o access token usando o refresh token atual</span>
            </span>
        </button>

        <a href="/test/jwks" class="btn btn-secondary">
            <span class="tooltip">
                Validar JWT com JWKS
                <span class="tooltiptext">Verificar assinatura do ID Token usando as chaves p√∫blicas JWKS</span>
            </span>
        </a>

        <a href="/test/discovery" class="btn btn-secondary">
            <span class="tooltip">
                OIDC Discovery
                <span class="tooltiptext">Visualizar documento de descoberta OpenID Connect</span>
            </span>
        </a>

        <button hx-post="/test/revoke"
                hx-target="#test-result"
                hx-indicator="#loading-indicator"
                hx-confirm="‚ö†Ô∏è Tem certeza? Isso vai revogar o token e encerrar a sess√£o atual."
                class="btn btn-danger">
            Revogar Token
        </button>
    </div>

    <div id="loading-indicator" class="htmx-indicator">
        <div class="spinner"></div>
        <span>Processando...</span>
    </div>

    <div id="test-result" class="mt-3"></div>
</div>

<div class="card mt-3">
    <h3>Hist√≥rico de Requisi√ß√µes</h3>
    <p>Visualize todas as requisi√ß√µes HTTP realizadas durante o fluxo OAuth2.</p>
    <a href="/history" class="btn btn-primary">Ver Hist√≥rico Completo</a>
</div>

{{template "footer" .}}
{{end}}
